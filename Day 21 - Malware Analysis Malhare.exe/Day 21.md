# Advent of Cyber 2025 - Day 21 - Malware Analysis: Malhare.exe

## 1. Introduction

And in our kingdom of Wareville, just like in others, thousands of files of all kinds pass through the systems every day, from DOCX, PDF resumes received by our elves, to financial spreadsheets, CSVs from the accounting department, and executable files launched by different applications. But have you ever wondered which of these might be malicious? Which ones could actually belong to King Malhare? An interesting question, isn’t it?

<br></br>

### Learning Objectives
---

In this task, the TBFC SOC team will investigate one specific file type, the HTA format - a type often used for legitimate purposes, yet just as frequently exploited by attackers. Your mission is to reverse-engineer the HTA and uncover how King Malhare tricked Wareville’s elves. To do this, you will have to look for:

- Application metadata
- Script functions
- Any network calls or encoded data
- Clues about exfiltration

<br></br>

### Connecting to the Machine
---

Click on the Start AttackBox button at the top and open the malware sample using pluma /root/Rooms/AoC2025/Day21/survey.hta.

Important!: This room uses an HTA malware file. It's safe, but do not run it locally. For safety and the intended experience, you should use the AttackBox; the file is already provided there. If you download it manually, browsers may block it. If it does download, open it only in a text editor, and do not execute it.

<br></br>

## 2. Malware Analysis

### HTA Overview
---

HTA (HTML Application) files are lightweight Windows applications built using **HTML, CSS, and scripting languages** such as VBScript or JavaScript.
Unlike standard HTML files that run inside a browser, HTAs execute directly on Windows using **Microsoft HTML Application Host (`mshta.exe`)**, granting them access to system-level capabilities.

Legitimate use cases include:

* Automating administrative or setup tasks
* Providing simple internal tools or interfaces
* Testing prototypes
* Lightweight IT utilities

Because HTAs combine scripting and native execution, they are frequently abused by attackers as malware launchers.

<br></br>

### HTA File Structure
---

A typical HTA file contains three main components:

1. **HTA Declaration**

   * Defined using the `<HTA:APPLICATION>` tag
   * Controls window behaviour, visibility, and execution properties

2. **Interface (HTML/CSS)**

   * Creates the visible UI (forms, buttons, text)

3. **Script Logic (VBScript / JavaScript)**

   * Executes actions, often including system commands or network requests

HTAs closely resemble HTML files, which makes them effective for social engineering.

<br></br>

### Malicious Use of HTA Files
---

Attackers leverage HTAs due to their ability to execute scripts natively on Windows.

Common malicious uses include:

* **Initial access via phishing**
* **Downloader / dropper behaviour**
* **Obfuscation using Base64 or short scripts**
* **Living-off-the-land execution** using tools like:

  * `mshta.exe`
  * `powershell.exe`
  * `wscript.exe`
  * `rundll32.exe`

Malicious HTAs often:

* Contain encoded payloads
* Download second-stage malware
* Execute content directly in memory

<br></br>

### Initial HTA Analysis
---

The suspicious HTA file is opened safely using a text editor to avoid execution:

```bash
pluma /root/Rooms/AoC2025/Day21/survey.hta
```

#### **Metadata Inspection**

* Review the `<head>` section to identify the declared purpose
* Attackers often disguise malicious files as surveys or internal tools

#### **Script Inspection**

* Locate `<script type="text/vbscript">`
* Identify functions, especially those:

  * Executed on load
  * Making network requests
  * Executing commands

Identified VBScript functions:

* `window_onLoad`
* `getQuestions`
* `provideFeedback`
* `decodeBase64`
* `RSBinaryToString`

<br></br>

### Suspicious Functionality
---

Key COM objects used within the script:

* `InternetExplorer.Application` → External connections
* `WScript.Network` → System enumeration
* `WScript.Shell` → Command execution

The function `getQuestions()` pretends to download survey data but actually retrieves malicious content.

The downloaded data is:

* Decoded
* Passed into a PowerShell execution command
* Executed directly in memory

This behaviour confirms malicious intent.

<br></br>

### Obfuscation and Payload Analysis
---

The downloaded payload uses:

* **Base64 encoding** to hide content
* **ROT13 encryption** for additional obfuscation

Decoding steps:

1. Decode Base64
2. Apply ROT13
3. Analyse resulting script

The decoded script reveals a hidden flag and confirms malicious execution.

<br></br>

## **Final Answers**

| Question                                       | Answer                                                                           |
| ---------------------------------------------- | -------------------------------------------------------------------------------- |
| Title of the HTA application                   | **Best Festival Company Developer Survey**                                       |
| VBScript function downloading survey questions | **getQuestions**                                                                 |
| URL domain questions are downloaded from       | **survey.bestfestiivalcompany.com**                                              |
| Typosquatting character in domain              | **i**                                                                            |
| Number of survey questions                     | **4**                                                                            |
| Promised trip destination                      | **South Pole**                                                                   |
| Exfiltrated system information                 | **ComputerName,UserName**                                                        |
| Exfiltration endpoint                          | **/details**                                                                     |
| HTTP method used                               | **GET**                                                                          |
| Line executing downloaded content              | **runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False** |
| Encoding used to obfuscate payload             | **base64**                                                                       |
| Encryption used in decoded script              | **rot13**                                                                        |
| Final flag                                     | **THM{Malware.Analysed}**                                                        |

<br></br>

## **Conclusion**

* HTA files can execute powerful scripts via `mshta.exe`
* Attackers abuse HTAs for phishing and malware delivery
* VBScript combined with PowerShell is a common attack pattern
* Base64 and ROT13 are frequently used for obfuscation
* Social engineering persists even within code (fake surveys, incentives)
* Static analysis prevents accidental execution during investigation
* Decoding and tracing execution flow is critical for HTA malware analysis

---
