# Advent of Cyber 2025 - Day 6 - Malware Analysis: Egg-xecutable

## 1. Introduction

The town of Wareville remains quiet in the middle of the night. While the residents of Wareville are nicely tucked up in bed, blissfully unaware, the SOC team at The Best Festival Company (TBFC) remain alert, poised and ready for whatever may face them.

Monitoring their screens, armed with a freshly poured mug of hot cocoa, the elves of the SOC watch their dashboards diligently. 

Suddenly, the elves receive an email in unison from Elf McClause, Head of Elf Affairs, in their inboxes. It reads:
```
From: Elf McClause
Subject: A new schedule awaits
Attachments: HopHelper.exe
 
To all Elves, going forward, we will be using a new program for creating and viewing team rotas. 
 
This new program will revolutionalise how rotas are made here at The Best Festival Company.
 
Please contact IT support if you have issues running the program.
 
Kind regards, remain the best,
 
Elf McClause
Head of Elf Affairs
```
"Why is Elf McClause working at 3AM?" Screams a member of the SOC team in the background. They're right, something is amiss.

Elf McBlue is immediately suspicious. Their years of experience in the SOC have given them the wisdom not to download "out of the blue" executables. Without McSkidy's wisdom, Elf McBlue takes charge, loading up their malware investigation toolkik - the investigation begins.
<br></br>

### Learning Objectives
---

Today's room will have you taking the place of Elf McBlue, a highly talented member of The Best Festival Company's malware investigation squad. You have been tasked with investigating a highly suspicious executable that is being shared within the company. In today's room, we will be covering the following:

- The principles of malware analysis
- An introduction to sandboxes
- Static vs. dynamic analysis
- Tools of the trade: PeStudio, ProcMon, Regshot
  <br></br>

### Connecting to the Machine
---

Start your target machine by clicking the Start Machine button below. The machine will open in split view and need about 2 minutes to fully boot. In case you can not see it, click the Show Split View button at the top of the page.

Alternatively, you can use the credentials below to connect to the target machine via RDP from your own THM VPN connected machine:

| Detail | Value |
| --- | --- |
| Username | ElfMcBlue |
| Password | TryH@cKMe1! |
| IP address | MACHINE_IP |
| Connection via | RDP |

**Note:** Do not execute the HopHelper.exe executable yet. The room will instruct you when to do so.
<br></br>

## 2. Malware Analysis Using Sandboxes

### Principles of Malware Analysis
---

Malware analysis is the process of examining a malicious file to understand its functionality, behaviour, and defensive countermeasures. By studying how a malware sample operates—whether it communicates with an attacker’s server, leaves traces on disk, or modifies registry keys—we can form strategies to detect and neutralise it.

There are **two major branches** of malware analysis:

* **Static Analysis** → inspecting the file *without* executing it
* **Dynamic Analysis** → executing the file in a controlled environment to observe behaviour

**Sandboxes**

A sandbox is an isolated environment (often a virtual machine) where potentially dangerous applications can be executed safely. Sandboxes follow the golden rule of malware analysis:

**Never run malware on a device you care about.**

Most sandboxes use VMs because snapshotting allows analysts to revert systems back to previous states. In this room, all malicious files, referred to as *samples*, must only be executed inside the provided analyst VM.

<br></br>

### Static Analysis
---

Static analysis helps collect early intelligence without executing the malware. Key indicators include:

| Information | Explanation                                                                             | Example                            |
| ----------- | --------------------------------------------------------------------------------------- | ---------------------------------- |
| Checksums   | Unique file identifiers for threat intelligence                                         | `a93f7e8c4d21b19f2e12f09a5c33e48a` |
| Strings     | Human-readable text inside binaries, such as IPs, URLs, or credentials                  | `138.62.51.186`                    |
| Imports     | OS functions the malware uses for file creation, process manipulation, networking, etc. | `CreateFileW`                      |
| Resources   | Icons and embedded content; sometimes where malware hides payloads                      | N/A                                |
<br></br>

**Demonstrating PeStudio**

Using **PeStudio** on the sample (`HopHelper.exe`):

1. Launch PeStudio
2. Load the executable via **drag-and-drop** or *File → Open File*
3. Open **Indicators** on the left
4. Locate the **SHA256Sum** under the file metadata
5. Open **Strings** to gather human-readable data inside the file

The SHA256 checksum acts as threat intelligence, while strings can reveal C2 servers, flags, commands, URLs, and more.

For **HopHelper.exe**, the required static-analysis findings are:

* SHA256Sum
* Hidden THM flag within strings

<br></br>


### Dynamic Analysis
---

Dynamic analysis involves executing the sample to observe its interactions with:

* Registry
* File system
* Network
* Processes

Two tools are used:

**Regshot**

Regshot compares registry snapshots to detect persistence or configuration changes.

**Steps:**

1. Open Regshot
2. Change the output path to Desktop
3. Take **1st shot** (before execution)
4. Execute **HopHelper.exe**
5. Take **2nd shot** (after execution)
6. Press **Compare** to generate differences

Look for added Run keys (common persistence method):

`HKU\...\Software\Microsoft\Windows\CurrentVersion\Run\HopHelper`

**ProcMon**

Process Monitor provides detailed runtime information on:

* Registry access
* File creation
* Network connections
* DLL loading

**Steps:**

1. Open **ProcMon**
2. Run **HopHelper.exe**
3. Wait ~1 minute
4. Stop capturing (Play/Pause button)
5. Apply filters:

   * Filter → *Process Name is HopHelper.exe*
   * Additional filter: *Operation contains TCP*

When filtered by TCP operations, network activity reveals the protocol used by the malware (e.g., HTTP).

This also helps identify the C2 panel in the bonus task.

<br></br>

## Final Answers

| Question                                                           | Answer                                                                                                       |
| ------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------ |
| Static analysis: What is the SHA256Sum of HopHelper.exe?           | **F29C270068F865EF4A747E2683BFA07667BF64E768B38FBB9A2750A3D879CA33**                                         |
| What is the THM flag found in strings?                             | **THM{STRINGS_FOUND}**                                                                                       |
| What registry key was modified for persistence?                    | **HKU\S-1-5-21-1966530601-3185510712-10604624-1008\Software\Microsoft\Windows\CurrentVersion\Run\HopHelper** |
| What network protocol does HopHelper.exe use (via TCP filter)?     | **http**                                                                                                     |
| Bonus: Can you find the web panel HopHelper.exe communicates with? | *No answer needed*                                                                                           |

<br></br>

## Conclusion

* Static analysis provides quick intelligence through hashes, strings, imports, and resources.
* PeStudio is effective for early reconnaissance of suspicious executables.
* Regshot reveals registry-based persistence mechanisms.
* ProcMon exposes live malware behaviour, including file, registry, and network operations.
* HopHelper.exe establishes persistence via Run keys and communicates using HTTP.
* Combining static and dynamic analysis gives a complete behavioural profile of the malware.

---